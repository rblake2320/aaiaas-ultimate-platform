# Docker Build and Push Workflow
# Builds and pushes Docker images for backend services

name: Docker Build

on:
  push:
      branches: [ master, main, develop ]
          paths:
                - 'apps/api-ai/**'
                      - 'apps/api-control/**'
                            - 'infra/docker/**'
                                  - '.github/workflows/docker-build.yml'
                                    pull_request:
                                        branches: [ master, main, develop ]

                                        jobs:
                                          build:
                                              runs-on: ubuntu-latest

                                                      strategy:
                                                            matrix:
                                                                    service:
                                                                              - name: 'ai-services'
                                                                                          dockerfile: 'apps/api-ai/Dockerfile'
                                                                                                      context: 'apps/api-ai'
                                                                                                                - name: 'control-plane'
                                                                                                                            dockerfile: 'apps/api-control/Dockerfile'
                                                                                                                                        context: 'apps/api-control'
                                                                                                                                        
                                                                                                                                            steps:
                                                                                                                                                - uses: actions/checkout@v4
                                                                                                                                                      with:
                                                                                                                                                              fetch-depth: 0
                                                                                                                                                              
                                                                                                                                                                  - name: Set up Docker Buildx
                                                                                                                                                                        uses: docker/setup-buildx-action@v2
                                                                                                                                                                        
                                                                                                                                                                            - name: Build Docker image
                                                                                                                                                                                  uses: docker/build-push-action@v4
                                                                                                                                                                                        with:
                                                                                                                                                                                                context: ${{ matrix.service.context }}
                                                                                                                                                                                                        file: ${{ matrix.service.dockerfile }}
                                                                                                                                                                                                                push: false
                                                                                                                                                                                                                        tags: aaiaas-${{ matrix.service.name }}:${{ github.sha }}
                                                                                                                                                                                                                                cache-from: type=gha
                                                                                                                                                                                                                                        cache-to: type=gha,mode=max
                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                            - name: Test Docker image
                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                          docker build \
                                                                                                                                                                                                                                                                    -f ${{ matrix.service.dockerfile }} \
                                                                                                                                                                                                                                                                              -t aaiaas-${{ matrix.service.name }}:test \
                                                                                                                                                                                                                                                                                        ${{ matrix.service.context }}
                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                          push:
                                                                                                                                                                                                                                                                                              needs: build
                                                                                                                                                                                                                                                                                                  runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                              strategy:
                                                                                                                                                                                                                                                                                                                    matrix:
                                                                                                                                                                                                                                                                                                                            service:
                                                                                                                                                                                                                                                                                                                                      - name: 'ai-services'
                                                                                                                                                                                                                                                                                                                                                  dockerfile: 'apps/api-ai/Dockerfile'
                                                                                                                                                                                                                                                                                                                                                              context: 'apps/api-ai'
                                                                                                                                                                                                                                                                                                                                                                        - name: 'control-plane'
                                                                                                                                                                                                                                                                                                                                                                                    dockerfile: 'apps/api-control/Dockerfile'
                                                                                                                                                                                                                                                                                                                                                                                                context: 'apps/api-control'
                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                    steps:
                                                                                                                                                                                                                                                                                                                                                                                                        - uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                            - name: Set up Docker Buildx
                                                                                                                                                                                                                                                                                                                                                                                                                  uses: docker/setup-buildx-action@v2
                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Login to GitHub Container Registry
                                                                                                                                                                                                                                                                                                                                                                                                                            uses: docker/login-action@v2
                                                                                                                                                                                                                                                                                                                                                                                                                                  with:
                                                                                                                                                                                                                                                                                                                                                                                                                                          registry: ghcr.io
                                                                                                                                                                                                                                                                                                                                                                                                                                                  username: ${{ github.actor }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                          password: ${{ secrets.GITHUB_TOKEN }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Build and push Docker image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    uses: docker/build-push-action@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  context: ${{ matrix.service.context }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          file: ${{ matrix.service.dockerfile }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  push: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          tags: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ghcr.io/${{ github.repository }}/aaiaas-${{ matrix.service.name }}:latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ghcr.io/${{ github.repository }}/aaiaas-${{ matrix.service.name }}:${{ github.sha }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      cache-from: type=gha
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              cache-to: type=gha,mode=max
