# Python CI Workflow for FastAPI Backend
# Tests Python code, linting, and type checking

name: Python CI

on:
  push:
      branches: [ master, main, develop ]
          paths:
                - 'apps/api-ai/**'
                      - 'requirements*.txt'
                            - '.github/workflows/python-ci.yml'
                              pull_request:
                                  branches: [ master, main, develop ]
                                      paths:
                                            - 'apps/api-ai/**'
                                                  - 'requirements*.txt'

                                                  jobs:
                                                    test:
                                                        runs-on: ubuntu-latest

                                                            strategy:
                                                                  matrix:
                                                                          python-version: ['3.11', '3.12']

                                                                              steps:
                                                                                  - uses: actions/checkout@v4
                                                                                        with:
                                                                                                fetch-depth: 0

                                                                                                    - name: Set up Python ${{ matrix.python-version }}
                                                                                                          uses: actions/setup-python@v4
                                                                                                                with:
                                                                                                                        python-version: ${{ matrix.python-version }}
                                                                                                                        
                                                                                                                            - name: Cache pip packages
                                                                                                                                  uses: actions/cache@v3
                                                                                                                                        with:
                                                                                                                                                path: ~/.cache/pip
                                                                                                                                                        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
                                                                                                                                                                restore-keys: |
                                                                                                                                                                          ${{ runner.os }}-pip-
                                                                                                                                                                          
                                                                                                                                                                              - name: Install dependencies
                                                                                                                                                                                    run: |
                                                                                                                                                                                            python -m pip install --upgrade pip
                                                                                                                                                                                                    pip install -r requirements.txt
                                                                                                                                                                                                            pip install pytest pytest-cov flake8 black mypy
                                                                                                                                                                                                            
                                                                                                                                                                                                                - name: Lint with flake8
                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                              # Stop the build if there are Python syntax errors or undefined names
                                                                                                                                                                                                                                      flake8 apps/api-ai --count --select=E9,F63,F7,F82 --show-source --statistics
                                                                                                                                                                                                                                              # Exit-zero treats all errors as warnings
                                                                                                                                                                                                                                                      flake8 apps/api-ai --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          - name: Check code style with black
                                                                                                                                                                                                                                                                run: black --check apps/api-ai --diff
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                    - name: Type check with mypy
                                                                                                                                                                                                                                                                          run: mypy apps/api-ai --ignore-missing-imports --check-untyped-defs
                                                                                                                                                                                                                                                                                continue-on-error: true
                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                    - name: Run tests with pytest
                                                                                                                                                                                                                                                                                          run: pytest apps/api-ai/tests --cov=apps/api-ai --cov-report=xml
                                                                                                                                                                                                                                                                                                continue-on-error: true
                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                    - name: Upload coverage to Codecov
                                                                                                                                                                                                                                                                                                          uses: codecov/codecov-action@v3
                                                                                                                                                                                                                                                                                                                with:
                                                                                                                                                                                                                                                                                                                        files: ./coverage.xml
                                                                                                                                                                                                                                                                                                                                flags: python
                                                                                                                                                                                                                                                                                                                                        fail_ci_if_error: false
