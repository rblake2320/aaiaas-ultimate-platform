# CodeQL Security Analysis Workflow
# Performs security analysis for TypeScript/JavaScript and Python code

name: CodeQL

on:
  push:
      branches: [ master, main, develop ]
          paths:
                - 'apps/**'
                      - 'packages/**'
                            - '.github/workflows/codeql.yml'
                              pull_request:
                                  branches: [ master, main, develop ]
                                    schedule:
                                        # Run CodeQL analysis at 2 AM UTC, three times per week (Mon, Wed, Fri)
                                            - cron: '0 2 * * 1,3,5'

                                            jobs:
                                              analyze:
                                                  name: Analyze with CodeQL
                                                      runs-on: ubuntu-latest
                                                          permissions:
                                                                actions: read
                                                                      contents: read
                                                                            security-events: write

                                                                                strategy:
                                                                                      fail-fast: false
                                                                                            matrix:
                                                                                                    language: [ 'javascript-typescript', 'python' ]
                                                                                                    
                                                                                                        steps:
                                                                                                            - name: Checkout repository
                                                                                                                  uses: actions/checkout@v4
                                                                                                                  
                                                                                                                      - name: Initialize CodeQL
                                                                                                                            uses: github/codeql-action/init@v2
                                                                                                                                  with:
                                                                                                                                          languages: ${{ matrix.language }}
                                                                                                                                                  config-file: ./.github/codeql/codeql-config.yml
                                                                                                                                                          queries: security-and-quality
                                                                                                                                                          
                                                                                                                                                              - name: Set up Node.js
                                                                                                                                                                    if: matrix.language == 'javascript-typescript'
                                                                                                                                                                          uses: actions/setup-node@v4
                                                                                                                                                                                with:
                                                                                                                                                                                        node-version: '18'
                                                                                                                                                                                                cache: 'npm'
                                                                                                                                                                                                
                                                                                                                                                                                                    - name: Install Node dependencies
                                                                                                                                                                                                          if: matrix.language == 'javascript-typescript'
                                                                                                                                                                                                                run: npm ci
                                                                                                                                                                                                                
                                                                                                                                                                                                                    - name: Set up Python
                                                                                                                                                                                                                          if: matrix.language == 'python'
                                                                                                                                                                                                                                uses: actions/setup-python@v4
                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                              python-version: '3.11'
                                                                                                                                                                                                                                                      cache: 'pip'
                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                          - name: Install Python dependencies
                                                                                                                                                                                                                                                                if: matrix.language == 'python'
                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                              python -m pip install --upgrade pip
                                                                                                                                                                                                                                                                                      pip install -r requirements.txt
                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                          - name: Perform CodeQL Analysis
                                                                                                                                                                                                                                                                                                uses: github/codeql-action/analyze@v2
                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                              category: "/language:${{ matrix.language }}"
                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                  - name: Upload CodeQL results to GitHub Security tab
                                                                                                                                                                                                                                                                                                                        uses: github/codeql-action/upload-sarif@v2
                                                                                                                                                                                                                                                                                                                              if: always()
                                                                                                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                                                                                                            sarif_file: 'results/${{ matrix.language }}.sarif'
                                                                                                                                                                                                                                                                                                                                                    wait-for-processing: true
